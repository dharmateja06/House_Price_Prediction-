{% extends "base.html" %}

{% block title %}Analytics - House Price Predictor{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        margin-bottom: 2rem;
        text-align: center;
    }
    
    .chart-container img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .stat-value {
        font-size: 2em;
        font-weight: bold;
        color: #3498db;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        color: #666;
        font-size: 0.9em;
    }
    
    .loading {
        text-align: center;
        padding: 2rem;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1>Data Analytics</h1>
        <p>Explore housing market trends and insights</p>
    </div>
    
    <div class="card-content">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading analytics...</p>
        </div>
        
        <div id="analytics-content" style="display: none;">
            <div class="stats-grid" id="stats-grid">
                <!-- Stats will be populated by JavaScript -->
            </div>
            
            <div class="chart-container">
                <h3>Price Distribution</h3>
                <img id="price-dist-chart" alt="Price Distribution Chart">
            </div>
            
            <div class="chart-container">
                <h3>Average Price by State</h3>
                <img id="price-by-state-chart" alt="Price by State Chart">
            </div>
            
            <div class="chart-container">
                <h3>Average Price by BHK</h3>
                <img id="bhk-vs-price-chart" alt="BHK vs Price Chart">
            </div>
            
            <div class="chart-container">
                <h3>Property Type Distribution</h3>
                <img id="property-type-chart" alt="Property Type Distribution Chart">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function loadAnalytics() {
        try {
            const response = await fetch('/api/analytics');
            const charts = await response.json();
            
            // Hide loading
            document.getElementById('loading').style.display = 'none';
            document.getElementById('analytics-content').style.display = 'block';
            
            // Load charts
            document.getElementById('price-dist-chart').src = 'data:image/png;base64,' + charts.price_dist;
            document.getElementById('price-by-state-chart').src = 'data:image/png;base64,' + charts.price_by_state;
            document.getElementById('bhk-vs-price-chart').src = 'data:image/png;base64,' + charts.bhk_vs_price;
            document.getElementById('property-type-chart').src = 'data:image/png;base64,' + charts.property_type_dist;
            
            // Load basic stats (you can add an API endpoint for this)
            loadStats();
            
        } catch (error) {
            document.getElementById('loading').innerHTML = '<p>Error loading analytics. Please try again.</p>';
        }
    }
    
    async function loadStats() {
        try {
            const response = await fetch('/api/data?per_page=1');
            const data = await response.json();
            
            const statsGrid = document.getElementById('stats-grid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${data.total.toLocaleString()}</div>
                    <div class="stat-label">Total Properties</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">â‚¹250</div>
                    <div class="stat-label">Avg Price (Lakhs)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">2.8</div>
                    <div class="stat-label">Avg BHK</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">28</div>
                    <div class="stat-label">States Covered</div>
                </div>
            `;
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }
    
    // Load analytics when page loads
    document.addEventListener('DOMContentLoaded', loadAnalytics);
</script>
{% endblock %}